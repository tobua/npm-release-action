import path from "path";
import { execSync } from 'child_process'
import { execa } from "execa";
import { readFileSync } from "fs";
import { createRequire } from 'node:module'
import getRegistry from "./get-registry.js";
import getChannel from "./get-channel.js";
import getReleaseInfo from "./get-release-info.js";

const require = createRequire(import.meta.url)

export default async function (npmrc, { npmPublish, pkgRoot }, pkg, context) {
  const {
    cwd,
    env,
    stdout,
    stderr,
    nextRelease: { version, channel },
    logger,
  } = context;

  if (npmPublish !== false && pkg.private !== true) {
    const basePath = pkgRoot ? path.resolve(cwd, pkgRoot) : cwd;
    const registry = getRegistry(pkg, context);
    const distTag = getChannel(channel);

    console.log('publish', basePath, npmrc)
    console.log('before', readFileSync(npmrc, 'utf-8'), 'after')
    console.log(cwd, process.cwd(), path.resolve(process.cwd(), '.npmrc'), path.resolve('npm'))

    console.log(execSync('npm --version', { encoding: 'utf-8' }), 'npm version')
    console.log(execSync('node --version', { encoding: 'utf-8' }), 'node version')

    const versionLocalResult = await execa(
      "npm",
      ["--version"],
      { cwd, env, preferLocal: true }
    );
    console.log('execa', versionLocalResult.stderr, versionLocalResult.stdout)

    const localPathResult = await execa(
      "which",
      ["npm"],
      { cwd, env, preferLocal: true }
    );
    console.log('which path', localPathResult.stderr, localPathResult.stdout)

    const versionResult = await execa(
      "npm",
      ["--version"],
      { cwd, env, preferLocal: false }
    );
    console.log('execa non local', versionResult.stderr, versionResult.stdout)

    console.log('resolved npm', require.resolve('npm'))

    logger.log(`Publishing version ${version} to npm registry on dist-tag ${distTag}`);
    const result = execa(
      "npm",
      ["publish", basePath, "--userconfig", npmrc, "--tag", distTag, "--registry", registry, '--provenance'],
      { cwd, env, preferLocal: true }
    );
    result.stdout.pipe(stdout, { end: false });
    result.stderr.pipe(stderr, { end: false });
    await result;

    logger.log(`Published ${pkg.name}@${version} to dist-tag @${distTag} on ${registry}`);

    return getReleaseInfo(pkg, context, distTag, registry);
  }

  logger.log(
    `Skip publishing to npm registry as ${npmPublish === false ? "npmPublish" : "package.json's private property"} is ${
      npmPublish !== false
    }`
  );

  return false;
}
